name: Daily Stock Data Fetch

on:
  schedule:
    # JST 3:00 AM (UTC 18:00 previous day)
    - cron: '0 18 * * *'
  workflow_dispatch: # Manual trigger for testing
    inputs:
      target_date:
        description: 'Target date (YYYY-MM-DD). Leave empty for latest'
        required: false
        type: string

jobs:
  fetch-data:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'

    - name: Install dependencies
      run: |
        npm ci
        # Install additional packages for data fetching
        npm install --save-dev @supabase/supabase-js dotenv

    - name: Run data fetch script
      env:
        SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
        SUPABASE_SERVICE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}
        JQUANTS_EMAIL: ${{ secrets.JQUANTS_EMAIL }}
        JQUANTS_PASSWORD: ${{ secrets.JQUANTS_PASSWORD }}
        TARGET_DATE: ${{ inputs.target_date }}
      run: node scripts/fetch-daily-data.js

    - name: Upload logs as artifact
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: fetch-logs-${{ github.run_number }}
        path: logs/
        retention-days: 7